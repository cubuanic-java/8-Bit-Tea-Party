;8-Bit Tea Party!
;License: Creative Commons.

;Пока что общий файл вместе с тестированием и работой с палитрой адаптера.
;Позже уже разделим на файл демонстрации и непосредственно на файл процедуры.

CPU 8086                                ;Поменять дриективы, если другой асм.

;Используем пока константы, которые здесь и после их перенесем в глобальный
;файл имен либо в заголовок библиотеки режима Х.

SCR_GFX_ADDR            EQU 0A000H      ;Сегментный адрес графического экрана.

;Video DAC palette registers.

VGA_DAC_WRITE           EQU 3C8h
VGA_DAC_READ            EQU 3C7h
VGA_DAC_DATA            EQU 3C9h
VGA_PEL_MASK            EQU 3C6h

        org 100h
        pushf
        mov ax,13h                      ;13h standard video mode.
        int 10h

;Тестовый код сыпать сюда. :)

        call near ColorTableDraw

        mov ah,00h                      ;Press any key...
        int 16h
        popf
        ret

;Примеры данных для подачи на вход процедуры установки палитры.

palette_rgb_8   db 100h * 03h dup (0)   ;24бит * 256 цветов = 768 байт.
palette_rgb_6   db 240h dup (0)         ;18бит * 256 цветов = 576 байт.

;Процедура установки цветовой палитры для адаптера VGA, режим Х, 256 цветов).
; Для первой тренировки можно использовать стандартный формат RGB(8 бит), т.е.
;на каждый компонент по одному байту в массиве 256*3=768 байт. Если всё
;нормально заработало, то уже можно попробовать реалзовать максимально
;упакованный формат: 3байта(24 бита) упакованы по 6бит потоком RGBR, где
;последние 6бит уже являются компонентом следующего цвета и также, со
;смещением уже идут следущие цвета палитры.
; Функции вызова БИОС-а не использовать, напрямую работаем с железом и не
;забывать про прерывания. Комментарии приветствуются. :)
;
;Входные параметры:
;AL     индекс первого цвета для установки в таблице, 0..255;
;AH     количество цветов для установки(0..255, если 0, то полностью, 256);
;CL     тип передаваемой палитры(пока в резерве, может потом уберем);
;DS:DX  адрес таблицы компонентов цветов, только на чтение, контроль данных
;       на стороне вызова.

VXSetPalette:
        pushf

;Главный код писать здесь. :)

        popf
        ret

;Draw standard palette to screen.

ColorTableDraw:
        pushf
        push ax
        push dx
        push si
        push di
        push es
        mov ax,SCR_GFX_ADDR
        mov es,ax                       ;Screen.
        xor di,di                       ;3clk
        ;sub di,di                       ;3clk
        mov si,di
        cld                             ;Forward.
        mov dx,0C8h                     ;200.
CTabDr2:mov di,si
        mov cx,0100h                    ;All 256 colors.
CTabDr1:mov es:[di],al
        inc al
        inc di
        loop CTabDr1
        add si,0140h
        dec dx
        jnz short CTabDr2
        pop es
        pop di
        pop si
        pop dx
        pop ax
        popf
        ret
